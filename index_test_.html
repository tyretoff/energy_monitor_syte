<!DOCTYPE HTML>
<html>

<head>
    <link rel="icon" href="/merc1/icon-192x192.png">
    <meta name="theme-color" content="#2196f3">
    <link rel="manifest" href="/merc1/manifest.json">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>MercuryDataLogger</title>
    <style>
        /* Общий стиль */
        body {
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        header {
            background-color: #2196f3;
            color: white;
            padding: 15px 0;
            width: 100%;
            text-align: center;
            font-size: 24px;
        }

        #latestData {
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #ffffff;
            padding: 10px;
            width: 90%;
            max-width: 1200px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0px 2px 4px rgba(0, 0, 0, 0.1);
        }

        #latestValues p {
            margin: 0 15px;
            font-size: 16px;
        }

        #controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 20px 0;
        }

        #controls input[type="date"] {
            padding: 5px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }

        #container2 {
            width: 90%;
            max-width: 1200px;
            height: 600px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0px 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        button {
            padding: 10px 15px;
            background-color: #2196f3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        button:hover {
            background-color: #1976d2;
        }

        #exportCSV {
            margin-bottom: 20px;
        }
    </style>
</head>

<body>
    <header>Mercury Data Logger</header>

    <div id="latestData">
        <div id="latestValues">
            <p id="latestTime">Время: </p>
            <p id="latestVoltage1">U1: </p>
            <p id="latestVoltage2">U2: </p>
            <p id="latestVoltage3">U3: </p>
            <p id="latestCurrent1">I1: </p>
            <p id="latestCurrent2">I2: </p>
            <p id="latestCurrent3">I3: </p>
            <p id="latestPower">P: </p>
        </div>
    </div>

    <div id="controls">
        <label for="startDate">С: </label>
        <input type="date" id="startDate">
        <label for="endDate">По: </label>
        <input type="date" id="endDate">
        <button id="loadData">Загрузить данные</button>
    </div>

    <div id="container2"></div>
    <button id="exportCSV">Экспорт в CSV</button>

    <script src="CD_/jquery-3.7.1.js"></script>
    <script src="CD_/highstock.js"></script>
    <script src="CD_/boost.js"></script>
    <script src="CD_/grid-light.js"></script>
    <script src="CD_/exporting.js"></script>

    <script>
        Highcharts.setOptions({
            lang: {
                loading: 'Загрузка...',
                months: ['Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь', 'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'],
                weekdays: ['Воскресенье', 'Понедельник', 'Вторник', 'Среда', 'Четверг', 'Пятница', 'Суббота'],
                shortMonths: ['Янв', 'Фев', 'Март', 'Апр', 'Май', 'Июнь', 'Июль', 'Авг', 'Сент', 'Окт', 'Нояб', 'Дек'],
                exportButtonTitle: "Экспорт",
                printButtonTitle: "Печать",
                rangeSelectorFrom: "С",
                rangeSelectorTo: "По",
                rangeSelectorZoom: "Период",
                downloadPNG: 'Скачать PNG',
                downloadJPEG: 'Скачать JPEG',
                downloadPDF: 'Скачать PDF',
                downloadSVG: 'Скачать SVG',
                printChart: 'Напечатать график'
            },
            accessibility: {
                enabled: false
            }
        });

        function loadData() {
            var startDate = $('#startDate').val();
            var endDate = $('#endDate').val();

            if (!startDate || !endDate) {
                alert("Пожалуйста, выберите даты.");
                return;
            }

            $.getJSON(`jsonp_.php?start=${startDate}&end=${endDate}`, data => {
                var voltage1 = [], voltage2 = [], voltage3 = [], current1 = [], current2 = [], current3 = [], P = [];

                data.forEach(row => {
                    voltage1.push([row[0] * 1000, row[1]]);
                    voltage2.push([row[0] * 1000, row[2]]);
                    voltage3.push([row[0] * 1000, row[3]]);
                    current1.push([row[0] * 1000, row[4]]);
                    current2.push([row[0] * 1000, row[5]]);
                    current3.push([row[0] * 1000, row[6]]);
                    P.push([row[0] * 1000, row[7]]);
                });

                var latest = data[data.length - 1];
                document.getElementById('latestTime').textContent = 'Время: ' + Highcharts.dateFormat('%Y-%m-%d %H:%M:%S', latest[0] * 1000);
                document.getElementById('latestVoltage1').textContent = 'U1: ' + latest[1];
                document.getElementById('latestVoltage2').textContent = 'U2: ' + latest[2];
                document.getElementById('latestVoltage3').textContent = 'U3: ' + latest[3];
                document.getElementById('latestCurrent1').textContent = 'I1: ' + latest[4];
                document.getElementById('latestCurrent2').textContent = 'I2: ' + latest[5];
                document.getElementById('latestCurrent3').textContent = 'I3: ' + latest[6];
                document.getElementById('latestPower').textContent = 'P: ' + latest[7];

                Highcharts.stockChart('container2', {
                    rangeSelector: {
                        selected: 1
                    },
                    title: {
                        text: 'Электросеть'
                    },
                    yAxis: [{
                        title: { text: 'Напряжение' }
                    }, {
                        title: { text: 'Ток' },
                        opposite: true
                    }],
                    series: [{
                        name: 'U1',
                        data: voltage1
                    }, {
                        name: 'U2',
                        data: voltage2
                    }, {
                        name: 'U3',
                        data: voltage3
                    }, {
                        name: 'I1',
                        data: current1
                    }, {
                        name: 'I2',
                        data: current2
                    }, {
                        name: 'I3',
                        data: current3
                    }, {
                        name: 'P',
                        data: P
                    }]
                });
            });
        }

        $(document).ready(function () {
            var today = new Date().toISOString().split('T')[0];
            var monthAgo = new Date();
            monthAgo.setMonth(monthAgo.getMonth() - 1);
            var monthAgoDate = monthAgo.toISOString().split('T')[0];

            $('#startDate').val(monthAgoDate);
            $('#endDate').val(today);

            loadData();
            $('#loadData').click(loadData);
        });

        document.getElementById('exportCSV').addEventListener('click', () => {
            var csv = 'Время,U1,U2,U3,I1,I2,I3,P\n';
            $.getJSON(`jsonp_.php?start=${$('#startDate').val()}&end=${$('#endDate').val()}`, data => {
                data.forEach(row => {
                    var formattedTime = Highcharts.dateFormat('%Y-%m-%d %H:%M:%S', row[0] * 1000);
                    csv += `${formattedTime},${row.slice(1).join(',')}\n`;
                });

                var hiddenElement = document.createElement('a');
                hiddenElement.href = 'data:text/csv;charset=utf-8,' + encodeURI(csv);
                hiddenElement.target = '_blank';
                hiddenElement.download = 'data.csv';
                hiddenElement.click();
            });
        });

        if ("serviceWorker" in navigator) {
            window.addEventListener("load", () => {
                navigator.serviceWorker.register("/merc1/service-worker.js")
                    .then(registration => {
                        console.log("Service Worker registered: ", registration);
                    })
                    .catch(error => {
                        console.log("Service Worker registration failed: ", error);
                    });
            });
        }
    </script>

</body>

</html>
