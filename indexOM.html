<!DOCTYPE HTML>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <link rel="icon" href="/merc1/icon-192x192.png">
    <meta name="theme-color" content="#2196f3">
    <link rel="manifest" href="/merc1/manifest.json">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="Content-Language" content="ru">
    <title>Мониторинг Меркурий236</title>
    <script>
        if ("serviceWorker" in navigator) {
            window.addEventListener("load", () => {
                navigator.serviceWorker.register("/merc1/service-worker.js")
                    .then(registration => {
                        console.log("Service Worker зарегистрирован: ", registration);
                    })
                    .catch(error => {
                        console.log("Ошибка регистрации Service Worker: ", error);
                    });
            });
        }
    </script>
    <style>
        body {
            margin: 20px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f2f5;
        }

        #header {
            background: #2c3e50;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        #latestData {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 15px;
        }

        .data-item {
            text-align: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
        }

        .data-label {
            font-size: 12px;
            color: #6c757d;
            margin-bottom: 5px;
        }

        .data-value {
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
        }

        #container2 {
            height: 700px;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        #exportCSV {
            margin-top: 20px;
            padding: 10px 25px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }

        #exportCSV:hover {
            background: #2980b9;
        }

        .highcharts-container {
            background-color: #f9f9f9 !important;
        }

        #statsContainer {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .stats-title {
            font-size: 16px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 15px;
            text-align: center;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 15px;
        }

        .stats-section {
            margin-bottom: 20px;
        }

        .stats-inline {
            font-size: 12px;
            margin-top: 2px;
            color: #6c757d;
        }

        .min-value {
            color: #e74c3c;
        }

        .max-value {
            color: #27ae60;
        }

        /* Оптимизация для мобильных устройств */
        @media (max-width: 768px) {
            body {
                margin: 10px;
            }
            
            #container2 {
                padding: 10px;
                height: 600px;
            }
            
            /* Уменьшаем левый отступ на мобильных устройствах */
            .highcharts-container svg {
                overflow: visible !important;
            }
            
            .highcharts-container .highcharts-root {
                overflow: visible !important;
            }
            
            /* Скрываем вертикальные оси в мобильной версии */
            .highcharts-yaxis .highcharts-axis-line,
            .highcharts-yaxis .highcharts-tick {
                display: none;
            }
            
            /* Настройки для графика на мобильных устройствах */
            .highcharts-plot-band, .highcharts-plot-line, .highcharts-yaxis, .highcharts-grid {
                transform: translateX(-10px);
            }
            
            /* Настройки сетки для мобильных устройств */
            .highcharts-grid-line {
                stroke-opacity: 0.3;
            }
            
            /* Настройки для меток осей */
            .highcharts-yaxis-labels {
                opacity: 0.8;
            }
            
            .highcharts-axis-title {
                font-size: 14px !important;
                font-weight: bold !important;
            }
            
            /* Оптимизация осей для мобильных устройств */
            .highcharts-yaxis-labels text {
                font-size: 10px !important;
            }
            
            .highcharts-yaxis .highcharts-axis-line {
                stroke-width: 1;
            }
            
            .highcharts-legend-item text {
                font-size: 11px !important;
            }
            
            #latestData {
                padding: 10px;
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
                gap: 10px;
            }
            
            .data-item {
                padding: 8px;
            }
            
            .data-value {
                font-size: 16px;
            }
        }
        
        /* Дополнительная оптимизация для очень маленьких экранов */
        @media (max-width: 480px) {
            body {
                margin: 5px;
            }
            
            #container2 {
                padding: 5px;
                height: 550px;
            }
            
            /* Дополнительная оптимизация отступов для маленьких экранов */
            .highcharts-plot-band, .highcharts-plot-line, .highcharts-yaxis, .highcharts-grid {
                transform: translateX(-15px);
            }
            
            /* Полностью скрываем вертикальные линии сетки */
            .highcharts-grid-line {
                stroke-opacity: 0.2;
            }
            
            /* Уменьшаем количество меток на осях */
            .highcharts-yaxis-labels text:nth-child(odd) {
                opacity: 0.5;
            }
            
            .highcharts-axis-title {
                font-size: 12px !important;
            }
            
            /* Оптимизация кнопок выбора диапазона */
            .highcharts-range-selector-buttons {
                transform: scale(0.95);
                transform-origin: left top;
            }
            
            #latestData {
                grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
                gap: 5px;
                padding: 5px;
            }
            
            .data-item {
                padding: 5px;
            }
            
            .data-value {
                font-size: 14px;
            }
            
            .data-label {
                font-size: 10px;
            }
            
            .stats-inline {
                font-size: 9px;
            }
            
            #header h1 {
                font-size: 18px !important;
            }
            
            #header p {
                font-size: 12px !important;
            }
            
            .highcharts-yaxis-labels text {
                font-size: 9px !important;
            }
        }
    </style>
</head>
<body>
    <div id="header">
        <h1 style="margin: 0;">Мониторинг Меркурий236</h1>
    </div>

    <p style="margin: 10px 0 15px; font-size: 14px; opacity: 0.9; text-align: center;">Последние показания контроллера</p>

    <div id="latestData">
        <div class="data-item">
            <div class="data-label">Время</div>
            <div class="data-value" id="latestTime">-</div>
        </div>
        <div class="data-item">
            <div class="data-label">Напряжение U1</div>
            <div class="data-value" id="latestVoltage1">-</div>
            <div class="stats-inline">
                <span class="max-value" id="maxVoltage1">-</span>/<span class="min-value" id="minVoltage1">-</span>
            </div>
        </div>
        <div class="data-item">
            <div class="data-label">Напряжение U2</div>
            <div class="data-value" id="latestVoltage2">-</div>
            <div class="stats-inline">
                <span class="max-value" id="maxVoltage2">-</span>/<span class="min-value" id="minVoltage2">-</span>
            </div>
        </div>
        <div class="data-item">
            <div class="data-label">Напряжение U3</div>
            <div class="data-value" id="latestVoltage3">-</div>
            <div class="stats-inline">
                <span class="max-value" id="maxVoltage3">-</span>/<span class="min-value" id="minVoltage3">-</span>
            </div>
        </div>
        <div class="data-item">
            <div class="data-label">Ток I1</div>
            <div class="data-value" id="latestCurrent1">-</div>
            <div class="stats-inline">
                <span class="max-value" id="maxCurrent1">-</span>/<span class="min-value" id="minCurrent1">-</span>
            </div>
        </div>
        <div class="data-item">
            <div class="data-label">Ток I2</div>
            <div class="data-value" id="latestCurrent2">-</div>
            <div class="stats-inline">
                <span class="max-value" id="maxCurrent2">-</span>/<span class="min-value" id="minCurrent2">-</span>
            </div>
        </div>
        <div class="data-item">
            <div class="data-label">Ток I3</div>
            <div class="data-value" id="latestCurrent3">-</div>
            <div class="stats-inline">
                <span class="max-value" id="maxCurrent3">-</span>/<span class="min-value" id="minCurrent3">-</span>
            </div>
        </div>
        <div class="data-item">
            <div class="data-label">Мощность P</div>
            <div class="data-value" id="latestPower">-</div>
            <div class="stats-inline">
                <span class="max-value" id="maxPower">-</span>/<span class="min-value" id="minPower">-</span>
            </div>
        </div>
    </div>

    <div id="container2"></div>
    <center><button id="exportCSV">Экспорт данных в Excel</button></center>

    <script src="CD_/jquery-3.7.1.js"></script>
    <script src="CD_/highstock.js"></script>
    <script src="CD_/boost.js"></script>
    <script src="CD_/grid-light.js"></script>
    <script src="CD_/exporting.js"></script>
    <script>
        Highcharts.setOptions({
            lang: {
                loading: 'Загрузка...',
                months: ['Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь', 
                        'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'],
                weekdays: ['Воскресенье', 'Понедельник', 'Вторник', 'Среда', 
                          'Четверг', 'Пятница', 'Суббота'],
                shortMonths: ['Янв', 'Фев', 'Мар', 'Апр', 'Май', 'Июн', 
                             'Июл', 'Авг', 'Сен', 'Окт', 'Ноя', 'Дек'],
                exportButtonTitle: "Экспорт",
                printButtonTitle: "Печать",
                rangeSelectorFrom: "С",
                rangeSelectorTo: "По",
                rangeSelectorZoom: "Период",
                downloadPNG: 'Скачать PNG',
                downloadJPEG: 'Скачать JPEG',
                downloadPDF: 'Скачать PDF',
                downloadSVG: 'Скачать SVG',
                printChart: 'Напечатать график',
                resetZoom: "Сбросить масштаб",
                resetZoomTitle: "Сбросить масштаб 1:1",
                contextButtonTitle: "Контекстное меню",
                decimalPoint: ',',
                thousandsSep: ' '
            },
            accessibility: {
                enabled: false
            }
        });

        // Функция для обновления статистики
        function updateStats(data, min, max) {
            var filteredData = data.filter(function(point) {
                return point[0] * 1000 >= min && point[0] * 1000 <= max;
            });
            
            if (filteredData.length === 0) return;
            
            // Инициализация минимальных и максимальных значений
            var stats = {
                voltage1: { min: Infinity, max: -Infinity },
                voltage2: { min: Infinity, max: -Infinity },
                voltage3: { min: Infinity, max: -Infinity },
                current1: { min: Infinity, max: -Infinity },
                current2: { min: Infinity, max: -Infinity },
                current3: { min: Infinity, max: -Infinity },
                power: { min: Infinity, max: -Infinity }
            };
            
            // Поиск минимальных и максимальных значений
            filteredData.forEach(function(point) {
                // Напряжение
                stats.voltage1.min = Math.min(stats.voltage1.min, point[1]);
                stats.voltage1.max = Math.max(stats.voltage1.max, point[1]);
                stats.voltage2.min = Math.min(stats.voltage2.min, point[2]);
                stats.voltage2.max = Math.max(stats.voltage2.max, point[2]);
                stats.voltage3.min = Math.min(stats.voltage3.min, point[3]);
                stats.voltage3.max = Math.max(stats.voltage3.max, point[3]);
                
                // Ток
                stats.current1.min = Math.min(stats.current1.min, point[4]);
                stats.current1.max = Math.max(stats.current1.max, point[4]);
                stats.current2.min = Math.min(stats.current2.min, point[5]);
                stats.current2.max = Math.max(stats.current2.max, point[5]);
                stats.current3.min = Math.min(stats.current3.min, point[6]);
                stats.current3.max = Math.max(stats.current3.max, point[6]);
                
                // Мощность
                stats.power.min = Math.min(stats.power.min, point[7]);
                stats.power.max = Math.max(stats.power.max, point[7]);
            });
            
            // Обновление элементов интерфейса
            document.getElementById('minVoltage1').textContent = stats.voltage1.min.toFixed(1);
            document.getElementById('maxVoltage1').textContent = stats.voltage1.max.toFixed(1);
            document.getElementById('minVoltage2').textContent = stats.voltage2.min.toFixed(1);
            document.getElementById('maxVoltage2').textContent = stats.voltage2.max.toFixed(1);
            document.getElementById('minVoltage3').textContent = stats.voltage3.min.toFixed(1);
            document.getElementById('maxVoltage3').textContent = stats.voltage3.max.toFixed(1);
            
            document.getElementById('minCurrent1').textContent = stats.current1.min.toFixed(1);
            document.getElementById('maxCurrent1').textContent = stats.current1.max.toFixed(1);
            document.getElementById('minCurrent2').textContent = stats.current2.min.toFixed(1);
            document.getElementById('maxCurrent2').textContent = stats.current2.max.toFixed(1);
            document.getElementById('minCurrent3').textContent = stats.current3.min.toFixed(1);
            document.getElementById('maxCurrent3').textContent = stats.current3.max.toFixed(1);
            
            document.getElementById('minPower').textContent = stats.power.min.toFixed(1);
            document.getElementById('maxPower').textContent = stats.power.max.toFixed(1);
        }

        $.getJSON('jsonp.php', function (data) {
            if (!data || data.length === 0) {
                console.error('Нет данных для отображения');
                alert('Ошибка: Нет данных для отображения');
                return;
            }

            var voltage1 = [], voltage2 = [], voltage3 = [],
                current1 = [], current2 = [], current3 = [],
                P = [], dataLength = data.length;

            for (var i = 0; i < dataLength; i++) {
                voltage1.push([data[i][0] * 1000, data[i][1]]);
                voltage2.push([data[i][0] * 1000, data[i][2]]);
                voltage3.push([data[i][0] * 1000, data[i][3]]);
                current1.push([data[i][0] * 1000, data[i][4]]);
                current2.push([data[i][0] * 1000, data[i][5]]);
                current3.push([data[i][0] * 1000, data[i][6]]);
                P.push([data[i][0] * 1000, data[i][7]]);
            }

            var latestIndex = dataLength - 1;
            document.getElementById('latestTime').textContent = 
                Highcharts.dateFormat('%Y-%m-%d %H:%M:%S', data[latestIndex][0] * 1000);
            document.getElementById('latestVoltage1').textContent = data[latestIndex][1].toFixed(1);
            document.getElementById('latestVoltage2').textContent = data[latestIndex][2].toFixed(1);
            document.getElementById('latestVoltage3').textContent = data[latestIndex][3].toFixed(1);
            document.getElementById('latestCurrent1').textContent = data[latestIndex][4].toFixed(1);
            document.getElementById('latestCurrent2').textContent = data[latestIndex][5].toFixed(1);
            document.getElementById('latestCurrent3').textContent = data[latestIndex][6].toFixed(1);
            document.getElementById('latestPower').textContent = data[latestIndex][7].toFixed(1);

            var chart = Highcharts.stockChart('container2', {
                chart: {
                    spacingLeft: 10,
                    spacingRight: 10,
                    marginLeft: isMobileDevice() ? 25 : 50,
                    marginRight: 15
                },
                
                rangeSelector: {
                    selected: 1,
                    inputEnabled: true,
                    buttonTheme: {
                        width: 32,
                        height: 20,
                        padding: 2
                    },
                    buttons: [{
                        type: 'minute',
                        count: 10,
                        text: '10м'
                    }, {
                        type: 'hour',
                        count: 1,
                        text: '1час'
                    }, {
                        type: 'hour',
                        count: 6,
                        text: '6час'
                    }, {
                        type: 'day',
                        count: 1,
                        text: '1дн'
                    }, {
                        type: 'week',
                        count: 1,
                        text: 'нед'
                    }, {
                        type: 'month',
                        count: 1,
                        text: 'мес'
                    }, {
                        type: 'year',
                        count: 1,
                        text: 'год'
                    }, {
                        type: 'all',
                        text: 'Всё'
                    }]
                },
                
                legend: {
                    enabled: true,
                    layout: 'horizontal',
                    align: 'center',
                    verticalAlign: 'bottom',
                    itemStyle: {
                        color: '#333',
                        fontSize: '12px'
                    },
                    itemHoverStyle: {
                        color: '#2980b9'
                    },
                    itemDistance: 8,
                    symbolHeight: 8,
                    symbolWidth: 8,
                    symbolRadius: 4
                },

                yAxis: [{
                    title: { 
                        text: 'U',
                        align: 'middle',
                        rotation: 0,
                        offset: 0,
                        y: -15,
                        x: -35
                    },
                    height: '40%',
                    resize: { enabled: true },
                    labels: {
                        align: 'right',
                        x: -8,
                        y: 3,
                        style: {
                            color: '#666'
                        }
                    },
                    offset: 0,
                    maxPadding: 0.05,
                    lineWidth: isMobileDevice() ? 0 : 1,
                    gridLineWidth: isMobileDevice() ? 0.5 : 1,
                    gridLineColor: '#e6e6e6',
                    minorGridLineColor: '#f2f2f2',
                    minorTickLength: 0
                }, {
                    title: { 
                        text: 'I',
                        align: 'middle',
                        rotation: 0,
                        offset: 0,
                        y: -15,
                        x: -35
                    },
                    top: '42%',
                    height: '40%',
                    labels: {
                        align: 'right',
                        x: -8,
                        y: 3,
                        style: {
                            color: '#666'
                        }
                    },
                    offset: 0,
                    maxPadding: 0.05,
                    lineWidth: isMobileDevice() ? 0 : 1,
                    gridLineWidth: isMobileDevice() ? 0.5 : 1,
                    gridLineColor: '#e6e6e6',
                    minorGridLineColor: '#f2f2f2',
                    minorTickLength: 0
                }, {
                    title: { 
                        text: 'P',
                        align: 'middle',
                        rotation: 0,
                        offset: 0,
                        y: -15,
                        x: -35
                    },
                    top: '85%',
                    height: '15%',
                    labels: {
                        align: 'right',
                        x: -8,
                        y: 3,
                        style: {
                            color: '#666'
                        }
                    },
                    offset: 0,
                    maxPadding: 0.05,
                    lineWidth: isMobileDevice() ? 0 : 1,
                    gridLineWidth: isMobileDevice() ? 0.5 : 1,
                    gridLineColor: '#e6e6e6',
                    minorGridLineColor: '#f2f2f2',
                    minorTickLength: 0
                }],

                tooltip: {
                    split: true,
                    valueDecimals: 1,
                    style: {
                        fontSize: '12px'
                    },
                    headerFormat: '<span style="font-size: 12px">{point.key}</span><br/>'
                },

                plotOptions: {
                    series: {
                        boostThreshold: 1,
                        events: {
                            legendItemClick: function() {
                                this.visible ? this.hide() : this.show();
                                return false;
                            }
                        }
                    },
                    spline: { 
                        dataGrouping: { enabled: true } 
                    }
                },

                boost: {
                    useGPUTranslations: true,
                    seriesThreshold: 1
                },

                series: [{
                    type: 'spline',
                    name: 'U1',
                    data: voltage1
                }, {
                    type: 'spline',
                    name: 'U2',
                    data: voltage2
                }, {
                    type: 'spline',
                    name: 'U3',
                    data: voltage3
                }, {
                    type: 'spline',
                    name: 'I1',
                    data: current1,
                    yAxis: 1
                }, {
                    type: 'spline',
                    name: 'I2',
                    data: current2,
                    yAxis: 1
                }, {
                    type: 'spline',
                    name: 'I3',
                    data: current3,
                    yAxis: 1
                }, {
                    type: 'spline',
                    name: 'P',
                    data: P,
                    yAxis: 2
                }]
            });

            var originalSetExtremes = chart.xAxis[0].setExtremes;
            chart.xAxis[0].setExtremes = function (min, max, redraw, animation) {
                var range = max - min;
                var units;
                if (range >= 365 * 24 * 3600 * 1000) {
                    units = [['month', [1]]];
                } else if (range >= 30 * 24 * 3600 * 1000) {
                    units = [['day', [1]]];
                } else if (range > 24 * 3600 * 1000) {
                    units = [['hour', [1]]];
                } else if (range >= 6 * 3600 * 1000) {
                    units = [['minute', [5]]];
                } else {
                    units = null;
                }
                chart.series.forEach(function (series) {
                    series.update({ dataGrouping: { units: units } }, false);
                });
                originalSetExtremes.call(this, min, max, redraw, animation);
                
                // Обновление статистики при изменении диапазона
                updateStats(data, min, max);
            };
            
            // Инициализация статистики при первой загрузке
            var initialExtremes = chart.xAxis[0].getExtremes();
            updateStats(data, initialExtremes.min, initialExtremes.max);

            $('#exportCSV').click(function () {
                var extremes = chart.xAxis[0].getExtremes();
                
                // Создаем XML для Excel
                var xml = '<?xml version="1.0"?>\n';
                xml += '<?mso-application progid="Excel.Sheet"?>\n';
                xml += '<Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet"\n';
                xml += ' xmlns:o="urn:schemas-microsoft-com:office:office"\n';
                xml += ' xmlns:x="urn:schemas-microsoft-com:office:excel"\n';
                xml += ' xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet">\n';
                
                // Добавляем стили
                xml += ' <Styles>\n';
                xml += '  <Style ss:ID="Default" ss:Name="Normal">\n';
                xml += '   <Alignment ss:Vertical="Bottom"/>\n';
                xml += '   <Borders/>\n';
                xml += '   <Font ss:FontName="Calibri" x:Family="Swiss" ss:Size="11" ss:Color="#000000"/>\n';
                xml += '   <Interior/>\n';
                xml += '   <NumberFormat/>\n';
                xml += '   <Protection/>\n';
                xml += '  </Style>\n';
                xml += '  <Style ss:ID="Header">\n';
                xml += '   <Font ss:FontName="Calibri" x:Family="Swiss" ss:Size="11" ss:Color="#000000" ss:Bold="1"/>\n';
                xml += '   <Interior ss:Color="#E0E0E0" ss:Pattern="Solid"/>\n';
                xml += '  </Style>\n';
                xml += '  <Style ss:ID="DateTime">\n';
                xml += '   <NumberFormat ss:Format="dd.mm.yyyy hh:mm:ss"/>\n';
                xml += '  </Style>\n';
                xml += '  <Style ss:ID="Number">\n';
                xml += '   <NumberFormat ss:Format="0.0"/>\n';
                xml += '  </Style>\n';
                xml += ' </Styles>\n';
                
                // Начало листа
                xml += ' <Worksheet ss:Name="Данные">\n';
                xml += '  <Table ss:ExpandedColumnCount="8" ss:ExpandedRowCount="' + 
                       (data.length + 1) + '" x:FullColumns="1" x:FullRows="1">\n';
                
                // Задаем ширину столбцов
                xml += '   <Column ss:Width="120"/>\n';
                xml += '   <Column ss:Width="80" ss:Span="6"/>\n';
                
                // Заголовки
                xml += '   <Row>\n';
                var headers = ['Дата', 'U1', 'U2', 'U3', 'I1', 'I2', 'I3', 'Мощность'];
                headers.forEach(function(header) {
                    xml += '    <Cell ss:StyleID="Header"><Data ss:Type="String">' + header + '</Data></Cell>\n';
                });
                xml += '   </Row>\n';
                
                // Данные
                data.forEach(function(row) {
                    if (row[0] * 1000 >= extremes.min && row[0] * 1000 <= extremes.max) {
                        xml += '   <Row>\n';
                        // Дата
                        xml += '    <Cell ss:StyleID="DateTime"><Data ss:Type="DateTime">' + 
                               Highcharts.dateFormat('%Y-%m-%dT%H:%M:%S.000', row[0] * 1000) + 
                               '</Data></Cell>\n';
                        // Значения
                        for(var i = 1; i < row.length; i++) {
                            xml += '    <Cell ss:StyleID="Number"><Data ss:Type="Number">' + 
                                   row[i].toFixed(1) + '</Data></Cell>\n';
                        }
                        xml += '   </Row>\n';
                    }
                });
                
                xml += '  </Table>\n';
                xml += '  <WorksheetOptions xmlns="urn:schemas-microsoft-com:office:excel">\n';
                xml += '   <PageSetup>\n';
                xml += '    <Layout x:Orientation="Landscape"/>\n';
                xml += '    <Header x:Margin="0.3"/>\n';
                xml += '    <Footer x:Margin="0.3"/>\n';
                xml += '    <PageMargins x:Bottom="0.75" x:Left="0.7" x:Right="0.7" x:Top="0.75"/>\n';
                xml += '   </PageSetup>\n';
                xml += '   <Selected/>\n';
                xml += '   <FreezePanes/>\n';
                xml += '   <FrozenNoSplit/>\n';
                xml += '   <SplitHorizontal>1</SplitHorizontal>\n';
                xml += '   <TopRowBottomPane>1</TopRowBottomPane>\n';
                xml += '   <ActivePane>2</ActivePane>\n';
                xml += '   <Panes>\n';
                xml += '    <Pane>\n';
                xml += '     <Number>3</Number>\n';
                xml += '    </Pane>\n';
                xml += '    <Pane>\n';
                xml += '     <Number>2</Number>\n';
                xml += '     <ActiveRow>0</ActiveRow>\n';
                xml += '    </Pane>\n';
                xml += '   </Panes>\n';
                xml += '   <ProtectObjects>False</ProtectObjects>\n';
                xml += '   <ProtectScenarios>False</ProtectScenarios>\n';
                xml += '  </WorksheetOptions>\n';
                xml += ' </Worksheet>\n';
                xml += '</Workbook>';
                
                // Создаем Blob с XML данными
                var blob = new Blob(['\ufeff' + xml], { type: 'application/vnd.ms-excel' });
                var link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = 'monitoring_' + Highcharts.dateFormat('%Y%m%d_%H%M%S', Date.now()) + '.xls';
                link.click();
                
                // Очищаем URL
                setTimeout(function() {
                    URL.revokeObjectURL(link.href);
                }, 100);
            });

            // Функция для определения мобильного устройства
            function isMobileDevice() {
                return window.innerWidth <= 768;
            }

            // Обработка изменения размера окна
            window.addEventListener('resize', function() {
                if (chart) {
                    var isMobile = isMobileDevice();
                    chart.update({
                        chart: {
                            marginLeft: isMobile ? 25 : 50
                        },
                        yAxis: [{
                            lineWidth: isMobile ? 0 : 1,
                            gridLineWidth: isMobile ? 0.5 : 1
                        }, {
                            lineWidth: isMobile ? 0 : 1,
                            gridLineWidth: isMobile ? 0.5 : 1
                        }, {
                            lineWidth: isMobile ? 0 : 1,
                            gridLineWidth: isMobile ? 0.5 : 1
                        }]
                    });
                }
            });
        }).fail(function() {
            console.error('Ошибка загрузки данных');
            alert('Ошибка подключения к серверу данных');
        });
    </script>
</body>
</html>